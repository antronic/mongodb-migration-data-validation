"use strict";var o=require("dotenv"),e=require("dayjs"),t=require("crypto"),l=require("murmurhash"),n=require("fs");const s=(o,e)=>o.getSiblingDB(e).getCollectionNames(),c=(o,e)=>o.aggregate(e).toArray(),i=(o,t="created_at",l=e().toDate(),n=e().toDate())=>({pipeline:[],_pipeline:[],round:0,limit:o&&o.maximumDocumentsPerRound||1e3,initalize(){if(o&&o.hasTTL){const s=o&&o.hasTTL&&o.expireAfterSeconds||0;let c=e(n).subtract(10,"minutes").toDate();const i=e(l).subtract(s,"second").add(30,"minutes").toDate(),g=o&&o.timeField||t;this.pipeline.push({$match:{[g]:{$gte:i,$lt:c}}})}return this.pipeline.push({$sort:{_id:1}}),this._pipeline=[...this.pipeline],this},setRound(o){return this._pipeline=[...this.pipeline],this.round=o,this._pipeline.push({$skip:(this.round-1)*this.limit}),this},generate(){return this._pipeline.push({$limit:this.limit}),this._pipeline}});o.config({override:!0});const g=process.env.ENCRYPTION_KEY,r=process.env.ENCRYPTION_IV,a=({hostname:o,username:e,encryptedPassword:l})=>{const n=(o=>{void 0!==g&&void 0!==r||(console.error("Please provide a KEY and IV in the .env file"),console.error("or run the command:\n$\tnpm run cli generate-key"),process.exit(1));const e=Buffer.from(g,"hex"),l=Buffer.from(r,"hex");if(console.log("KEY:",e.length),console.log("IV:",l.length),32!==e.length||16!==l.length)throw new Error("Invalid KEY or IV length. KEY must be 32 bytes and IV must be 16 bytes.");try{const n=t.createDecipheriv("aes-256-cbc",e,l);let s=n.update(o,"hex","utf8");return s+=n.final("utf8"),s}catch(o){throw console.error("Decryption error:",o.message),o}})(l);return connect(`mongodb://${e}:${n}@${o}?tls=true&tlsAllowInvalidHostnames=true&directConnection=true`)},m=o=>{if("object"!=typeof o)return"not an object";const e=Object.keys(o).sort().map((e=>{const t=o[e];return null===t?`${e}:null`:void 0===t?`${e}:undefined`:`${encodeURIComponent(e)}:${"object"==typeof t?m(t):encodeURIComponent(t)}`}));return t=e.join(""),l.v3(t).toString();var t};!function(){o.config({override:!0});const t=require("./config.qc.js");const l=new Map;console.log("** QC always enabled Debug mode"),t.debug="full",t.databases.filter((o=>o.isExclude||"exclude"===t.listMode)).map((o=>o.name)),"include"!==t.listMode||t.databases.filter((o=>!o.isExclude)).map((o=>o.name));(o=>{const t=["full","info"].includes(o.debug),g=o.debug;t?console.log("** Debug mode enabled"):console.log("-- Debug mode disabled");const r=o.databases.filter((e=>e.isExclude||"exclude"===o.listMode)).map((o=>o.name)),u="include"===o.listMode?o.databases.filter((o=>!o.isExclude)).map((o=>o.name)):[];(()=>{const d=new Map,h=db,$=(o=>{const e=["admin","local","config"],t=o.adminCommand({listDatabases:1}),l=[];return t.databases.forEach((o=>{e.includes(o.name)||l.push(o.name)})),l})(db).filter((e=>{const t=o.databases.find((o=>o.name===e)),l="include"===o.listMode?!r.includes(e)&&u.includes(e):!r.includes(e);return t&&d.set(e,t),l}));console.log("Source DBs:"),console.log($);const p=a(o.target);console.log();for(const o of $){console.log(`\tdb > ${o}`);const r=d.get(o),a=[],u=[];r&&r.collections&&r.collections.forEach((o=>{("exclude"===r.listMode?r.collections.includes(o):!r.collections.includes(o))&&a.push(o),"include"===r.listMode&&r.collections.includes(o)&&u.push(o)})),console.log("\t\texcludedCollections:",a),console.log("\t\tincludedCollections:",u);const $=s(h,o).filter((o=>{if(!r)return!0;return"include"===r.listMode?u.includes(o):!a.includes(o)})),D=new Map;(r&&r.collectionDefinition||[]).forEach((o=>$.includes(o.name)&&D.set(o.name,o.options))),console.log(),console.log("\tCollections:"),console.log(`\tcoll > ${$}`),console.log();const b=[];for(const l of $){const s=Date.now(),r=D.get(l);null==r||r.maximumDocumentsPerRound;let a=0,u=0;const d=[],$=[];let V=0,E=0,T=1;const v=i(r).initalize();for(;;){const s=v.setRound(T).generate();"full"===g&&(console.log(),console.log(),console.log("----------------- AGGEGRATE PIPELINE -----------------"),console.log(),console.log(s),console.log(),console.log());const i=Date.now(),D=h.getSiblingDB(o).getCollection(l);console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Retrieving documents...`);const b=Date.now();console.log(`[${e().format("HH:mm:ss")}]\t\t [Source] - Retrieving documents...`);const M=c(D,s);console.log(`[${e().format("HH:mm:ss")}]\t\t [Source] - Retrieving documents - Done - [${Date.now()-b}ms]`),console.log();const R=Date.now();console.log(`[${e().format("HH:mm:ss")}]\t\t [Target] - Retrieving documents...`);const S=p.getSiblingDB(o).getCollection(l),w=c(S,s);console.log(`[${e().format("HH:mm:ss")}]\t\t [Target] - Retrieving documents - Done - [${Date.now()-R}ms]`),console.log(),++T,console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Retrieving documents - Done - [${Date.now()-i}ms]`);const C=Date.now();let x="",y="";"full"===g&&(console.log(),console.log(),console.log("=================================================="),console.log("#####################################################################################"),console.log(),console.log("<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"),console.log(`Source documents - [Length: ${M.length}]`),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"),console.log(M),console.log(),console.log("#####################################################################################"),console.log(),console.log("<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"),console.log(`Target documents - [Length: ${M.length}]`),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"),console.log(w),console.log("=================================================="),console.log(),console.log(),f=`${o}.${l}.source`,H={metaData:{source:{length:M.length},target:{length:w.length}},sourceDocuments:M,targetDocuments:w},n.existsSync("./.reports")||n.mkdirSync("./.reports"),n.writeFileSync(`./.reports/${f}.json`,JSON.stringify(H,null,2)),console.log(`\n\t*** Report file created: ./.reports/${f}.json ***`)),r&&r.hasTTL?(t&&console.log("\t\t[DEBUG] [HAS TTL index]"),t&&console.log(`\t\t[DEBUG] Hased Match enabled: ${!0!==r.disabledHashedMatch}`),r.disabledHashedMatch?(console.log(`[${e().format("HH:mm:ss")}]\t\tCounting documents...`),d.push(M.length.toString()),$.push(w.length.toString()),console.log(`\t\tSource Documents: ${M.length}`),console.log(`\t\t\tCount: ${M.length}`),console.log(`\t\tTarget Documents: ${w.length}`),console.log(`\t\t\tCount: ${w.length}`),console.log("\t\tResult: "+(M.length===w.length?"Match":"Mismatch")),console.log()):(console.log(`[${e().format("HH:mm:ss")}]\t\tHashing documents...`),x=m(M),y=m(w),console.log(`[${e().format("HH:mm:ss")}]\t\tHased completed - [${Date.now()-C}]`),d.push(x),$.push(y),console.log(`\t\tSource Documents: ${M.length}`),console.log(`\t\t\tHash: ${x}`),console.log(`\t\tTarget Documents: ${w.length}`),console.log(`\t\t\tHash: ${y}`),console.log("\t\tResult: "+(x===y?"Match":"Mismatch")),console.log())):(t&&console.log("[DEBUG] NO TTL index"),console.log(`[${e().format("HH:mm:ss")}]\t\tHashing documents...`),x=m(M),y=m(w),console.log(`[${e().format("HH:mm:ss")}]\t\tHased completed - [${Date.now()-C}]`),d.push(x),$.push(y),console.log(`\t\tSource Documents: ${M.length}`),console.log(`\t\t\tHash: ${x}`),console.log(`\t\tTarget Documents: ${w.length}`),console.log(`\t\t\tHash: ${y}`),console.log("\t\tResult: "+(x===y?"Match":"Mismatch")),console.log()),a+=M.length,u+=w.length,x!==y?(console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Source: ${a} - Target: ${u}`),console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Hash mismatch`),console.log("----------------------------------"),console.log(),V++):E++,console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Current mismatch: ${V} / match: ${E}`),console.log(`[${e().format("HH:mm:ss")}][INFO] \t${o}.${l} - DONE - QR runs only once`);break}console.log(),console.log("-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"),console.log(),console.log("----------------------------------"),console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Source: ${a} - Target: ${u}`),console.log(`[${e().format("HH:mm:ss")}]\tTotal round: ${T-1}`);const M=m(d),R=m($);console.log(),console.log(`[${e().format("HH:mm:ss")}]\tSource Hash: ${M} - Target Hash: ${R}`),console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - ${M===R?"Match":"Mismatch"}`),console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - All mismatch: ${V} / match: ${E} out of ${T-1} rounds`);const S=Date.now()-s;console.log(),console.log(`[${e().format("HH:mm:ss")}]\t${o}.${l} - Done [${S}ms]`),console.log("--------------------------------------------------"),console.log(),console.log("\t Creating collection report...");const w={collectionName:l,isValid:M===R,totalTime:S,stats:{source:{count:a,hash:M},target:{count:u,hash:R}}};b.push(w),console.log()}console.log("\t Creating database report...");const V={dbName:o,isValid:b.every((o=>o.isValid)),collections:b};l.set(o,V),console.log(),console.log("====================== DONE ======================"),console.log(),console.log("****************"),console.log()}var f,H;console.log(),console.log("================================================="),console.log("================ Validation DONE ================"),console.log("=========VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV========="),console.log(),console.log("================================================="),console.log("==================== REPORT ====================="),console.log("================================================="),console.log(),console.log(l)})(),console.log("\n\t*** QC Process done, and exitting ***")})(t)}();
