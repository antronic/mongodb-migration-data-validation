import o from"dayjs";import e from"dotenv";import t from"crypto";import s from"murmurhash";e.config();const n=process.env.ENCRYPTION_KEY,l=process.env.ENCRYPTION_IV,c=({hostname:o,username:e,encryptedPassword:s})=>{const c=(o=>{void 0!==n&&void 0!==l||(console.error("Please provide a KEY and IV in the .env file"),console.error("or run the command:\n$\tnpm run cli generate-key"),process.exit(1));const e=Buffer.from(n,"hex"),s=Buffer.from(l,"hex"),c=t.createDecipheriv("aes-256-cbc",e,s);let a=c.update(o,"hex","utf8");return a+=c.final("utf8"),a})(s);return connect(`mongodb://${e}:${c}@${o}?tls=true&tlsAllowInvalidHostnames=true&directConnection=true`)},a=o=>{const e=["admin","local","config"],t=o.adminCommand({listDatabases:1}),s=[];return t.databases.forEach((o=>{e.includes(o.name)||s.push(o.name)})),s},r=(o,e)=>o.getSiblingDB(e).getCollectionNames(),i=(e,t,s=1,n="created_at",l=o().toDate(),c=o().toDate())=>{const a=t&&t.maximumDocumentsPerRound||1e3,r=[];if(t&&t.hasTTL){const e=l,s=t&&t.hasTTL&&t.expireAfterSeconds||0;let a=o(c).add(s,"second").subtract(1,"hour").toDate();const i=t&&t.timeField||n;r.push({$match:{[i]:{$gte:e,$lt:a}}})}r.push({$sort:{_id:1}}),r.push({$skip:(s-1)*a}),r.push({$limit:a});return e.aggregate(r).toArray()},m=o=>{const e=Object.keys(o).sort().map((e=>{const t=o[e];return`${e}:${"object"==typeof t?m(t):t}`}));return t=e.join(""),s.v3(t).toString();var t},g=new Map,u=e=>{const t=e.databases.filter((o=>o.isExclude||"exclude"===e.listMode)).map((o=>o.name)),s="include"===e.listMode?e.databases.filter((o=>!o.isExclude)).map((o=>o.name)):[];(()=>{const n=new Map,l=db,u=a(db).filter((o=>{const l=e.databases.find((e=>e.name===o)),c="include"===e.listMode?!t.includes(o)&&s.includes(o):!t.includes(o);return l&&n.set(o,l),c}));console.log("Source DBs:"),console.log(u);const d=c(e.target);a(d),console.log();for(const e of u){console.log(`\tdb > ${e}`);const t=n.get(e),s=[],c=[];t&&t.collections&&t.collections.forEach((o=>{("exclude"===t.listMode?t.collections.includes(o):!t.collections.includes(o))&&s.push(o),"include"===t.listMode&&t.collections.includes(o)&&c.push(o)})),console.log("\t\texcludedCollections:",s),console.log("\t\tincludedCollections:",c);const a=r(l,e).filter((o=>{if(!t)return!0;return"include"===t.listMode?c.includes(o):!s.includes(o)})),u=new Map;(t&&t.collectionDefination||[]).forEach((o=>a.includes(o.name)&&u.set(o.name,o.options))),console.log(),console.log("\tCollections:"),console.log(`\tcoll > ${a}`),console.log();const $=[];for(const t of a){const s=Date.now(),n=u.get(t),c=(null==n?void 0:n.maximumDocumentsPerRound)||1e3;let a=0,r=0;const g=[],f=[];let h=1;for(;;){const s=Date.now(),u=l.getSiblingDB(e).getCollection(t);console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Retrieving documents...`);const $=Date.now();console.log(`[${o().format("HH:mm:ss")}]\t\t [Source] - Retrieving documents...`);const H=i(u,n,h);console.log(`[${o().format("HH:mm:ss")}]\t\t [Source] - Retrieving documents - Done - [${Date.now()-$}]`),console.log();const p=Date.now();console.log(`[${o().format("HH:mm:ss")}]\t\t [Target] - Retrieving documents...`);const V=d.getSiblingDB(e).getCollection(t),D=i(V,n,h);console.log(`[${o().format("HH:mm:ss")}]\t\t [Target] - Retrieving documents - Done - [${Date.now()-p}]`),console.log(),++h,console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Retrieving documents - Done - [${Date.now()-s}]`);const b=Date.now();console.log(`[${o().format("HH:mm:ss")}]\t\tHashing documents...`);const v=m(H),w=m(D);if(console.log(`[${o().format("HH:mm:ss")}]\t\tHased completed - [${Date.now()-b}]`),g.push(v),f.push(w),console.log(`\t\tSource Documents: ${H.length}`),console.log(`\t\t\tHash: ${v}`),console.log(`\t\tTarget Documents: ${D.length}`),console.log(`\t\t\tHash: ${w}`),console.log(),a+=H.length,r+=D.length,H.length<c)break;if(v!==w){console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Source: ${a} - Target: ${r}`),console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Hash mismatch`),console.log("----------------------------------");break}}console.log("----------------------------------"),console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Source: ${a} - Target: ${r}`),console.log(`[${o().format("HH:mm:ss")}]\tTotal round: ${h-1}`);const H=m(g),p=m(f);console.log(),console.log(`[${o().format("HH:mm:ss")}]\tSource Hash: ${H} - Target Hash: ${p}`),console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - ${H===p?"Match":"Mismatch"}`);const V=Date.now()-s;console.log(),console.log(`[${o().format("HH:mm:ss")}]\t${e}.${t} - Done [${V}ms]`),console.log("--------------------------------------------------"),console.log(),console.log("\t Creating collection report...");const D={collectionName:t,isValid:H===p,totalTime:V,stats:{source:{count:a,hash:H},target:{count:r,hash:p}}};$.push(D),console.log()}console.log("\t Creating database report...");const f={dbName:e,isValid:$.every((o=>o.isValid)),collections:$};g.set(e,f),console.log(),console.log("====================== DONE ======================"),console.log(),console.log("****************"),console.log()}console.log(),console.log("================================================="),console.log("================ Validation DONE ================"),console.log("=========VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV========="),console.log(),console.log("================================================="),console.log("==================== REPORT ====================="),console.log("================================================="),console.log(),console.log(g)})()};export{u as default};
